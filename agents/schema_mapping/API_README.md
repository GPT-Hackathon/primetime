# Schema Mapping API

REST API wrapper for the Schema Mapping Agent, deployable to Google Cloud Run.

## Overview

This API exposes the schema mapping functionality as a REST service, allowing you to generate intelligent schema mappings between BigQuery datasets via HTTP requests.

## Features

- ✅ RESTful API using FastAPI
- ✅ Wraps existing `schema_mapper.py` (no modifications needed)
- ✅ Deployable to Google Cloud Run
- ✅ Auto-generated API documentation (Swagger/OpenAPI)
- ✅ Health check endpoints
- ✅ Request validation with Pydantic
- ✅ Error handling and proper HTTP status codes

## API Endpoints

### 1. Generate Schema Mapping

**Endpoint:** `POST /generate-mapping`

**Request Body:**
```json
{
  "source_dataset": "worldbank_staging_dataset",
  "target_dataset": "worldbank_target_dataset",
  "mode": "FIX",
  "project_id": "my-gcp-project"  // optional
}
```

**Parameters:**
- `source_dataset` (required): Source BigQuery dataset name
- `target_dataset` (required): Target BigQuery dataset name
- `mode` (required): "REPORT" or "FIX"
- `project_id` (optional): GCP project ID (uses environment variable if not provided)

**Response:**
```json
{
  "status": "success",
  "mapping": {
    "metadata": {
      "source_dataset": "...",
      "target_dataset": "...",
      "mode": "FIX",
      "confidence": "high"
    },
    "mappings": [...]
  },
  "metadata": {
    "source_dataset": "worldbank_staging_dataset",
    "target_dataset": "worldbank_target_dataset",
    "mode": "FIX",
    "num_mappings": 5,
    "confidence": "high"
  }
}
```

### 2. Simple Mapping (Query Parameters)

**Endpoint:** `POST /generate-mapping/simple`

**Query Parameters:**
```
POST /generate-mapping/simple?source_dataset=staging&target_dataset=prod&mode=FIX
```

### 3. Health Check

**Endpoint:** `GET /health`

**Response:**
```json
{
  "status": "healthy"
}
```

### 4. Example Mapping

**Endpoint:** `GET /mappings/example`

Returns an example mapping response for reference.

### 5. API Documentation

**Endpoint:** `GET /docs`

Interactive Swagger UI documentation (automatically generated by FastAPI).

## Local Development

### Prerequisites

```bash
# Install dependencies
pip install -r requirements.txt
```

### Run Locally

```bash
# Set environment variables
export GCP_PROJECT_ID="your-project-id"
export GOOGLE_CLOUD_LOCATION="us-central1"
export GOOGLE_GENAI_USE_VERTEXAI=1

# Start the server
python api.py

# Or use uvicorn directly
uvicorn api:app --reload --port 8080
```

### Test Locally

```bash
# Health check
curl http://localhost:8080/health

# Generate mapping
curl -X POST http://localhost:8080/generate-mapping \
  -H "Content-Type: application/json" \
  -d '{
    "source_dataset": "worldbank_staging_dataset",
    "target_dataset": "worldbank_target_dataset",
    "mode": "FIX"
  }'

# View API docs
open http://localhost:8080/docs
```

## Cloud Run Deployment

### Option 1: Quick Deploy Script

```bash
# Make the script executable
chmod +x deploy.sh

# Run deployment
./deploy.sh
```

### Option 2: Manual Deployment

```bash
# Set variables
export PROJECT_ID="your-gcp-project"
export REGION="us-central1"

# Enable APIs
gcloud services enable cloudbuild.googleapis.com run.googleapis.com

# Build and deploy
gcloud builds submit --tag gcr.io/${PROJECT_ID}/schema-mapping-api
gcloud run deploy schema-mapping-api \
  --image gcr.io/${PROJECT_ID}/schema-mapping-api \
  --region ${REGION} \
  --platform managed \
  --allow-unauthenticated \
  --memory 2Gi \
  --cpu 2 \
  --timeout 300
```

### Option 3: Cloud Build (CI/CD)

```bash
# Deploy using Cloud Build
gcloud builds submit --config cloudbuild.yaml
```

## Docker

### Build Docker Image

```bash
docker build -t schema-mapping-api .
```

### Run Docker Container

```bash
docker run -p 8080:8080 \
  -e GCP_PROJECT_ID="your-project" \
  -e GOOGLE_CLOUD_LOCATION="us-central1" \
  -e GOOGLE_APPLICATION_CREDENTIALS="/path/to/key.json" \
  schema-mapping-api
```

## Environment Variables

| Variable | Description | Required | Default |
|----------|-------------|----------|---------|
| `GCP_PROJECT_ID` | GCP Project ID | Yes | - |
| `GOOGLE_CLOUD_LOCATION` | GCP region | Yes | us-central1 |
| `GOOGLE_GENAI_USE_VERTEXAI` | Use Vertex AI | Yes | 1 |
| `PORT` | API server port | No | 8080 |
| `GOOGLE_APPLICATION_CREDENTIALS` | Path to service account key | No | Uses ADC |

## API Usage Examples

### Python

```python
import requests

url = "https://schema-mapping-api-xxxxx.run.app/generate-mapping"
payload = {
    "source_dataset": "staging",
    "target_dataset": "prod",
    "mode": "FIX"
}

response = requests.post(url, json=payload)
mapping = response.json()

print(f"Generated {mapping['metadata']['num_mappings']} mappings")
```

### cURL

```bash
curl -X POST https://your-service-url.run.app/generate-mapping \
  -H "Content-Type: application/json" \
  -d '{
    "source_dataset": "staging",
    "target_dataset": "prod",
    "mode": "REPORT"
  }' | jq .
```

### JavaScript/Node.js

```javascript
const response = await fetch('https://your-service-url.run.app/generate-mapping', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    source_dataset: 'staging',
    target_dataset: 'prod',
    mode: 'FIX'
  })
});

const mapping = await response.json();
console.log(`Mappings: ${mapping.metadata.num_mappings}`);
```

## Response Status Codes

- `200 OK`: Successful mapping generation
- `400 Bad Request`: Invalid request parameters
- `404 Not Found`: Endpoint not found
- `500 Internal Server Error`: Server error (check logs)

## Error Response Format

```json
{
  "status": "error",
  "message": "Error description",
  "detail": "Additional error details"
}
```

## Monitoring

### Cloud Run Logs

```bash
gcloud run services logs read schema-mapping-api \
  --region us-central1 \
  --limit 50
```

### Health Check

```bash
curl https://your-service-url.run.app/health
```

## Cost Optimization

- **Auto-scaling**: Scales to zero when not in use
- **Min instances**: Set to 0 (default)
- **Max instances**: Set to 10 (adjustable)
- **Memory**: 2Gi (sufficient for LLM operations)
- **CPU**: 2 (for faster response times)
- **Timeout**: 300s (5 minutes for large datasets)

## Security

### Authentication

For production, enable authentication:

```bash
gcloud run deploy schema-mapping-api \
  --no-allow-unauthenticated
```

Then use IAM for access control:

```bash
gcloud run services add-iam-policy-binding schema-mapping-api \
  --member="user:email@example.com" \
  --role="roles/run.invoker"
```

### API Keys

Add API key validation in `api.py`:

```python
from fastapi import Header, HTTPException

async def verify_api_key(x_api_key: str = Header(...)):
    if x_api_key != os.getenv("API_KEY"):
        raise HTTPException(status_code=401, detail="Invalid API key")
```

## Files

- `api.py` - FastAPI application (wraps schema_mapper.py)
- `schema_mapper.py` - Existing mapping logic (unchanged)
- `requirements.txt` - Python dependencies
- `Dockerfile` - Container definition
- `cloudbuild.yaml` - Cloud Build configuration
- `deploy.sh` - Deployment script
- `.dockerignore` - Files to exclude from Docker build

## Architecture

```
┌─────────────────┐
│   HTTP Request  │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│   FastAPI       │  ← api.py (new wrapper)
│   Router        │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ schema_mapper   │  ← schema_mapper.py (unchanged)
│ .generate_      │
│  schema_mapping │
└────────┬────────┘
         │
         ├─────────────────┐
         │                 │
         ▼                 ▼
┌──────────────┐  ┌───────────────┐
│   BigQuery   │  │  Vertex AI    │
│   Schema     │  │  Gemini 2.5   │
└──────────────┘  └───────────────┘
```

## Troubleshooting

### Issue: "Module not found"
**Solution**: Ensure all files are in the same directory during build

### Issue: "BigQuery permission denied"
**Solution**: Ensure Cloud Run service account has BigQuery permissions

### Issue: "Timeout"
**Solution**: Increase timeout to 300s or more for large datasets

### Issue: "Out of memory"
**Solution**: Increase memory allocation to 2Gi or 4Gi

## Support

For issues or questions:
1. Check API documentation at `/docs`
2. View Cloud Run logs
3. Review `schema_mapper.py` for underlying logic

## Version

**Version:** 1.0.0
**Last Updated:** 2025-12-16
**Model:** Gemini 2.5 Flash
