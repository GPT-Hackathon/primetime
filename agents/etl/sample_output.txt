-- ####################################################
-- #          Generated ETL SQL Script                #
-- ####################################################


-- Populating 'ccibt-hack25ww7-750.worldbank_target_dataset.dim_country' from 'ccibt-hack25ww7-750.worldbank_staging_dataset.staging_countries'
INSERT INTO `ccibt-hack25ww7-750.worldbank_target_dataset.dim_country` (
    country_key, country_name, iso3, region, income_group
)
SELECT
    country_code AS country_key, country_name AS country_name, iso3 AS iso3, region AS region, income_group AS income_group
FROM
    `ccibt-hack25ww7-750.worldbank_staging_dataset.staging_countries`;

-- ------------------------------------------------------------------


-- Populating 'ccibt-hack25ww7-750.worldbank_target_dataset.dim_indicator' from 'ccibt-hack25ww7-750.worldbank_staging_dataset.staging_indicators_meta'
INSERT INTO `ccibt-hack25ww7-750.worldbank_target_dataset.dim_indicator` (
    indicator_code, indicator_name, topic
)
SELECT
    indicator_code AS indicator_code, indicator_name AS indicator_name, topic AS topic
FROM
    `ccibt-hack25ww7-750.worldbank_staging_dataset.staging_indicators_meta`;

-- ------------------------------------------------------------------


-- Populating 'ccibt-hack25ww7-750.worldbank_target_dataset.dim_time' by UNIONing multiple sources
INSERT INTO `ccibt-hack25ww7-750.worldbank_target_dataset.dim_time` (
    year, year_key
)
SELECT year AS year, CAST(year AS STRING) AS year_key FROM `ccibt-hack25ww7-750.worldbank_staging_dataset.staging_gdp` UNION ALL SELECT year AS year, CAST(year AS STRING) AS year_key FROM `ccibt-hack25ww7-750.worldbank_staging_dataset.staging_population` UNION ALL SELECT year AS year, CAST(year AS STRING) AS year_key FROM `ccibt-hack25ww7-750.worldbank_staging_dataset.staging_co2_emissions` UNION ALL SELECT year AS year, CAST(year AS STRING) AS year_key FROM `ccibt-hack25ww7-750.worldbank_staging_dataset.staging_life_expectancy` UNION ALL SELECT year AS year, CAST(year AS STRING) AS year_key FROM `ccibt-hack25ww7-750.worldbank_staging_dataset.staging_poverty_headcount` UNION ALL SELECT year AS year, CAST(year AS STRING) AS year_key FROM `ccibt-hack25ww7-750.worldbank_staging_dataset.staging_primary_enrollment`;

-- ------------------------------------------------------------------


-- Populating 'ccibt-hack25ww7-750.worldbank_target_dataset.fact_indicator_values' by UNIONing multiple sources
INSERT INTO `ccibt-hack25ww7-750.worldbank_target_dataset.fact_indicator_values` (
    country_key, year, indicator_code, numeric_value, data_source, loaded_at
)
SELECT country_code AS country_key, year AS year, indicator_code AS indicator_code, CAST(value AS NUMERIC) AS numeric_value, CURRENT_TIMESTAMP() AS data_source, CURRENT_TIMESTAMP() AS loaded_at FROM `ccibt-hack25ww7-750.worldbank_staging_dataset.staging_co2_emissions` UNION ALL SELECT country_code AS country_key, year AS year, indicator_code AS indicator_code, CAST(value AS NUMERIC) AS numeric_value, CURRENT_TIMESTAMP() AS data_source, CURRENT_TIMESTAMP() AS loaded_at FROM `ccibt-hack25ww7-750.worldbank_staging_dataset.staging_gdp` UNION ALL SELECT country_code AS country_key, year AS year, indicator_code AS indicator_code, CAST(value AS NUMERIC) AS numeric_value, CURRENT_TIMESTAMP() AS data_source, CURRENT_TIMESTAMP() AS loaded_at FROM `ccibt-hack25ww7-750.worldbank_staging_dataset.staging_life_expectancy` UNION ALL SELECT country_code AS country_key, year AS year, indicator_code AS indicator_code, CAST(value AS NUMERIC) AS numeric_value, CURRENT_TIMESTAMP() AS data_source, CURRENT_TIMESTAMP() AS loaded_at FROM `ccibt-hack25ww7-750.worldbank_staging_dataset.staging_population` UNION ALL SELECT country_code AS country_key, year AS year, indicator_code AS indicator_code, CAST(value AS NUMERIC) AS numeric_value, CURRENT_TIMESTAMP() AS data_source, CURRENT_TIMESTAMP() AS loaded_at FROM `ccibt-hack25ww7-750.worldbank_staging_dataset.staging_poverty_headcount` UNION ALL SELECT country_code AS country_key, year AS year, indicator_code AS indicator_code, CAST(value AS NUMERIC) AS numeric_value, CURRENT_TIMESTAMP() AS data_source, CURRENT_TIMESTAMP() AS loaded_at FROM `ccibt-hack25ww7-750.worldbank_staging_dataset.staging_primary_enrollment`;

-- ------------------------------------------------------------------

-- WARNING: No source table found for target 'ccibt-hack25ww7-750.worldbank_target_dataset.fact_loan_snapshot'.
-- Please define the source and complete the query below.

INSERT INTO `ccibt-hack25ww7-750.worldbank_target_dataset.fact_loan_snapshot` (loan_id, borrower_id, facility_id, snapshot_date_key, snapshot_date, outstanding_principal, current_rate_pct, margin_bps, rating_grade, score)
SELECT ... ;

-- WARNING: No source table found for target 'ccibt-hack25ww7-750.worldbank_target_dataset.fact_payments'.
-- Please define the source and complete the query below.

INSERT INTO `ccibt-hack25ww7-750.worldbank_target_dataset.fact_payments` (payment_id, date_key, payment_date, loan_id, borrower_id, facility_id, index_id, index_name, tenor_months, payment_amount, principal_component, interest_component, fee_component, days_past_due, currency, payment_method, margin_bps)
SELECT ... ;


-- Populating 'ccibt-hack25ww7-750.worldbank_target_dataset.agg_country_year' by PIVOTING from 'ccibt-hack25ww7-750.worldbank_target_dataset.target_fact_indicator_values'
INSERT INTO `ccibt-hack25ww7-750.worldbank_target_dataset.agg_country_year` (
    country_key, year, gdp, population, gdp_per_capita, life_expectancy, co2_emissions, primary_enrollment, poverty_headcount
)
SELECT
    country_code AS country_key, year AS year, MAX(IF(indicator_code = 'NY.GDP.MKTP.CD', numeric_value, NULL)) AS gdp, MAX(IF(indicator_code = 'SP.POP.TOTL', numeric_value, NULL)) AS population, SAFE_DIVIDE(MAX(IF(indicator_code = 'NY.GDP.MKTP.CD', numeric_value, NULL)), MAX(IF(indicator_code = 'SP.POP.TOTL', numeric_value, NULL))) AS gdp_per_capita, MAX(IF(indicator_code = 'SP.DYN.LE00.IN', numeric_value, NULL)) AS life_expectancy, MAX(IF(indicator_code = 'EN.ATM.CO2E.KT', numeric_value, NULL)) AS co2_emissions, MAX(IF(indicator_code = 'SE.PRM.ENRR', numeric_value, NULL)) AS primary_enrollment, MAX(IF(indicator_code = 'SI.POV.NAHC', numeric_value, NULL)) AS poverty_headcount
FROM
    `ccibt-hack25ww7-750.worldbank_target_dataset.target_fact_indicator_values`
GROUP BY
    country_key, year;

-- ------------------------------------------------------------------
