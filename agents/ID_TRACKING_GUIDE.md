# Agent ID Tracking Guide

This document explains the different IDs generated by agents in the system and their purposes.

## Overview

The agent system generates three main types of IDs that users see:
1. **`mapping_id`** - Identifies schema mappings
2. **`validation_id`** - Identifies validation runs
3. **`workflow_id`** - Tracks end-to-end workflows

Additionally, there are supporting IDs:
- **`load_id`** - Identifies staging data loads (used internally)
- **`run_id`** - Tracks BigQuery validation job runs (UUID format)

---

## 1. mapping_id

### Purpose
Identifies a schema mapping between source and target datasets.

### Generated By
- **Schema Mapping Agent** (`agents/schema_mapping/agent.py`)
- **Orchestration Agent** (`agents/orchestration/agent.py`)

### Format
```
{source_dataset}_to_{target_dataset}_{mode}
```

**Example:** `worldbank_staging_dataset_to_worldbank_target_dataset_fix`

### When Generated
Created when a schema mapping is generated between two datasets.

### Storage
- **Schema Mapping Agent**: Stored in `_mapping_store` dictionary (in-memory)
- **Orchestration Agent**: Stored in `_schema_mappings` dictionary (in-memory)

### User-Facing Functions

#### Schema Mapping Agent
- `save_mapping(mapping_json, mapping_id)` - Save a mapping with custom ID
- `load_mapping(mapping_id)` - Load a saved mapping
- `list_mappings()` - List all saved mapping IDs
- `extract_validation_rules(mapping_id, table_name)` - Extract rules from mapping

#### Orchestration Agent
- `generate_schema_mapping()` - Auto-generates and returns `mapping_id`
- `get_mapping(mapping_id)` - Retrieve a specific mapping
- `list_mappings()` - List all mappings in workflow

### Sample Response
```json
{
  "status": "success",
  "workflow_id": "workflow_20241216_143052",
  "mapping_id": "worldbank_staging_dataset_to_worldbank_target_dataset_fix",
  "message": "Schema mapping generated successfully",
  "summary": {
    "num_table_mappings": 3,
    "confidence": "high",
    "mode": "FIX"
  },
  "next_steps": [
    "Use validate_data() to validate the staging data",
    "Use get_mapping('worldbank_staging_dataset_to_worldbank_target_dataset_fix') to retrieve the full mapping"
  ]
}
```

---

## 2. validation_id

### Purpose
Identifies a specific validation run and its results.

### Generated By
- **Validation Agent** (`agents/validation/agent.py`)
- **Orchestration Agent** (`agents/orchestration/agent.py`)

### Format

**Validation Agent:**
```
validation_{timestamp}
```
**Example:** `validation_20241216143245`

**Orchestration Agent:**
```
{mapping_id}_validation_{timestamp}
```
**Example:** `worldbank_staging_dataset_to_worldbank_target_dataset_fix_validation_20241216143245`

### When Generated
Created after running data quality validations on tables.

### Storage
- Stored in `_validation_results` dictionary (in-memory)
- Actual error details stored in BigQuery `{dataset}.staging_errors` table

### User-Facing Functions

#### Validation Agent
- `validate_tables()` - Runs validation and returns `validation_id`
- `get_validation_results(validation_id)` - Retrieve validation results
- `list_validations()` - List all validation IDs

#### Orchestration Agent
- `validate_data(mapping_id, mode)` - Runs validation and returns both `validation_id` and `workflow_id`
- `get_validation_results(validation_id)` - Retrieve results
- `list_validations()` - List all validations

### Sample Response
```json
{
  "status": "success",
  "workflow_id": "workflow_20241216_143052",
  "validation_id": "worldbank_staging_dataset_to_worldbank_target_dataset_fix_validation_20241216143245",
  "run_id": "3e4a7b2c-8f9d-4e1a-b5c6-7d8e9f0a1b2c",
  "summary": {
    "tables_validated": 3,
    "total_validations": 15,
    "total_errors": 7
  },
  "message": "Validation completed. Found 7 errors.",
  "next_steps": [
    "Query staging_errors table to see details: run_id = '3e4a7b2c-8f9d-4e1a-b5c6-7d8e9f0a1b2c'",
    "Use get_validation_results('worldbank_staging_dataset_to_worldbank_target_dataset_fix_validation_20241216143245') for full results"
  ]
}
```

---

## 3. workflow_id

### Purpose
Tracks an entire end-to-end data integration workflow across multiple steps.

### Generated By
- **Orchestration Agent** (`agents/orchestration/agent.py`)

### Format
```
workflow_{timestamp}
```

**Example:** `workflow_20241216_143052`

### When Generated
Created automatically when starting any workflow operation (load, mapping, validation) if not provided.

### Storage
Stored in `_workflow_state` dictionary with complete history of all steps.

### Tracks
A workflow can include multiple steps:
1. **staging_load** - Data loaded from GCS to BigQuery
2. **schema_mapping** - Schema mapping generated
3. **data_validation** - Data quality validation run
4. **etl_execution** - ETL SQL executed (future)

### User-Facing Functions

#### Orchestration Agent
- `load_staging_data()` - Returns `workflow_id` + `load_id`
- `generate_schema_mapping()` - Returns `workflow_id` + `mapping_id`
- `validate_data()` - Returns `workflow_id` + `validation_id`
- `run_end_to_end_workflow()` - Returns `workflow_id` with all sub-IDs
- `get_workflow_status(workflow_id)` - Get complete workflow state
- `list_workflows()` - List all workflows

### Sample Response
```json
{
  "status": "success",
  "workflow_id": "workflow_20241216_143052",
  "load_id": "worldbank_staging_dataset_countries",
  "message": "Data loaded successfully to staging",
  "result": {
    "table": "ccibt-hack25ww7-750.worldbank_staging_dataset.countries",
    "rows": 250
  },
  "next_steps": [
    "Data loaded to worldbank_staging_dataset",
    "Use generate_schema_mapping() to map to target schema",
    "Use get_workflow_status('workflow_20241216_143052') to check progress"
  ]
}
```

### Workflow State Structure
```json
{
  "workflow_20241216_143052": {
    "created_at": "2024-12-16T14:30:52.123456",
    "steps": [
      {
        "step": "staging_load",
        "status": "completed",
        "load_id": "worldbank_staging_dataset_countries",
        "timestamp": "2024-12-16T14:30:52.123456",
        "summary": {
          "dataset": "worldbank_staging_dataset",
          "file": "data/countries.csv"
        }
      },
      {
        "step": "schema_mapping",
        "status": "completed",
        "mapping_id": "worldbank_staging_dataset_to_worldbank_target_dataset_fix",
        "timestamp": "2024-12-16T14:31:15.789012",
        "summary": {
          "num_mappings": 3,
          "mode": "FIX"
        }
      },
      {
        "step": "data_validation",
        "status": "completed",
        "validation_id": "worldbank_staging_dataset_to_worldbank_target_dataset_fix_validation_20241216143245",
        "mapping_id": "worldbank_staging_dataset_to_worldbank_target_dataset_fix",
        "timestamp": "2024-12-16T14:32:45.345678",
        "summary": {
          "tables_validated": 3,
          "total_errors": 7
        }
      }
    ]
  }
}
```

---

## Supporting IDs

### load_id

**Purpose:** Identifies a staging data load operation

**Format:** `{dataset_name}_{table_name}`

**Example:** `worldbank_staging_dataset_countries`

**Generated By:** Orchestration Agent

**Usage:** Internal tracking of data loads within workflows

---

### run_id

**Purpose:** Unique identifier for a BigQuery validation job (UUID format)

**Format:** UUID v4

**Example:** `3e4a7b2c-8f9d-4e1a-b5c6-7d8e9f0a1b2c`

**Generated By:** Validation Agent

**Usage:** 
- Filter validation errors in BigQuery `staging_errors` table
- Each validation run gets a unique UUID
- Allows querying specific validation results in BigQuery

**Query Example:**
```sql
SELECT * FROM `project.dataset.staging_errors`
WHERE run_id = '3e4a7b2c-8f9d-4e1a-b5c6-7d8e9f0a1b2c'
```

---

## ID Relationships

```
workflow_id (top-level)
├── load_id (staging load)
├── mapping_id (schema mapping)
│   └── Used to generate validation_id
└── validation_id (validation run)
    └── run_id (BigQuery job)
```

### Example Flow
1. User starts workflow → generates `workflow_20241216_143052`
2. Load data → generates `load_id`: `worldbank_staging_dataset_countries`
3. Generate mapping → generates `mapping_id`: `worldbank_staging_dataset_to_worldbank_target_dataset_fix`
4. Validate data → generates:
   - `validation_id`: `worldbank_staging_dataset_to_worldbank_target_dataset_fix_validation_20241216143245`
   - `run_id`: `3e4a7b2c-8f9d-4e1a-b5c6-7d8e9f0a1b2c` (for BigQuery)

---

## Session Persistence

### Current State: In-Memory Only
All IDs are stored in memory and **will be lost** when the agent session ends.

**Impact:**
- Schema Mapping Agent: `_mapping_store` is cleared on restart
- Validation Agent: `_validation_results` is cleared on restart
- Orchestration Agent: `_workflow_state`, `_schema_mappings`, `_validation_results` all cleared

### What Persists
- BigQuery tables created during loads (staging tables)
- Validation errors in `{dataset}.staging_errors` table (can be queried by `run_id`)
- ETL job logs in `{dataset}.etl_job_log` table

### Future Enhancement Options
To persist IDs across sessions, consider:
1. Store in Cloud Storage (JSON files)
2. Store in Firestore/Datastore
3. Store metadata in BigQuery tables
4. Use ADK state management features (if available)

---

## Best Practices

### For Users

1. **Save Important IDs**
   - Copy `workflow_id` to track your entire workflow
   - Save `mapping_id` if you want to reuse mappings
   - Save `validation_id` to review validation results later
   - Save `run_id` to query specific validation errors in BigQuery

2. **Use List Functions**
   - `list_workflows()` - See all active workflows
   - `list_mappings()` - See all saved mappings
   - `list_validations()` - See all validation runs

3. **Chaining Operations**
   - Pass `workflow_id` to subsequent operations to maintain workflow continuity
   - Use `mapping_id` from one step as input to validation
   - Reference `run_id` when querying BigQuery for error details

### For Developers

1. **ID Naming Conventions**
   - Use descriptive names that include context
   - Include timestamps for uniqueness
   - Follow consistent format patterns

2. **ID Storage**
   - Always store IDs in response objects
   - Include IDs in "next_steps" guidance
   - Log IDs for debugging

3. **Cross-Agent References**
   - Pass IDs between agents through function parameters
   - Maintain ID relationships in workflow state
   - Document which IDs are required for each operation

---

## Summary Table

| ID Type | Format | Generated By | Purpose | Persistence |
|---------|--------|--------------|---------|-------------|
| `mapping_id` | `{source}_to_{target}_{mode}` | Schema Mapping, Orchestration | Identify schema mappings | In-memory |
| `validation_id` | `validation_{timestamp}` or `{mapping_id}_validation_{timestamp}` | Validation, Orchestration | Identify validation runs | In-memory |
| `workflow_id` | `workflow_{timestamp}` | Orchestration | Track end-to-end workflows | In-memory |
| `load_id` | `{dataset}_{table}` | Orchestration | Track staging loads | In-memory |
| `run_id` | UUID v4 | Validation | BigQuery job identifier | BigQuery table |

---

## Questions & Answers

### Q: Is workflow_id the same as the JSON saved mapping_id?
**A:** No, they are different:
- `workflow_id` tracks the entire workflow across multiple steps (load → map → validate → ETL)
- `mapping_id` identifies a specific schema mapping that can be saved/loaded
- A single `workflow_id` can contain one `mapping_id` (plus `load_id`, `validation_id`, etc.)
- `mapping_id` can be saved to JSON using `save_mapping()` function

### Q: When I created the schema_mapping agent, I created a feature to save JSON with an ID - is that feature still there?
**A:** Yes! The feature is in `agents/schema_mapping/agent.py`:
- `save_mapping(mapping_json, mapping_id)` - Save mapping with custom ID
- `load_mapping(mapping_id)` - Load a previously saved mapping
- `list_mappings()` - See all saved mappings
- These mappings are stored in-memory in `_mapping_store` dictionary

### Q: What ID should I use to query validation errors in BigQuery?
**A:** Use the `run_id` (UUID format) returned by validation:
```sql
SELECT * FROM `project.dataset.staging_errors`
WHERE run_id = '3e4a7b2c-8f9d-4e1a-b5c6-7d8e9f0a1b2c'
```

---

*Last Updated: December 16, 2024*

